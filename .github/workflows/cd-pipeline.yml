name: CD Pipeline

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2

            - name: Terraform Init
              run: terraform init
              working-directory: terraform

            - name: Terraform Apply
              run: terraform apply -auto-approve
              working-directory: terraform
              env:
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                TF_VAR_openweather_api_key: ${{ secrets.OPENWEATHER_API_KEY }}

            - name: Post Apply - Output EIP
              run: terraform output -raw elastic_ip
              working-directory: terraform
              id: eip_output

            - name: Display the application URL
              run: echo "Application is deployed at http://$(terraform output -raw elastic_ip):5000"
